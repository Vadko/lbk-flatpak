server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;

    location = / {
        return 302 /repo/;
    }

    location /repo/ {
        autoindex on;

        # OSTree needs proper content types
        types {
            application/octet-stream commit dirtree dirmeta filez;
        }

        # Allow Flatpak clients
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD";

        # Cache static content aggressively (content-addressed)
        location ~* /objects/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Summary file changes on updates
        location ~* /summary {
            expires 5m;
        }
    }

    # Serve .flatpakref with correct MIME type
    location ~ \.flatpakref$ {
        default_type application/vnd.flatpak.ref;
    }
}
